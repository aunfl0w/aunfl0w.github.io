<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Aun&#39;s Blog  | Alter system calls with LD_PRELOAD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link rel="stylesheet" href="https://aunfl0w.github.io/css/blog.css" />
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-125094479-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://aunfl0w.github.io">Home</a>
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(https://aunfl0w.github.io/img/bg-blog.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Alter system calls with LD_PRELOAD
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="use-ld_preload-to-alter-library-calls">Use LD_PRELOAD to alter library calls</h1>
<p>I have a program that is failing because it is making a system call to change permissins on a file with <code>chmod</code>, <code>fchmodat</code>, and <code>fchmod</code> -S 2.  The program does not own the file, and doesn&rsquo;t need to change the permission but fails with <code>-1 EPERM</code> on this call.  This was determined with <code>strace -f -e chmod,fchmod,fchmodat $program</code></p>
<h2 id="example-program">Example program</h2>
<p>This program simulates the behaviour of the application with the issue.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt; </span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]) {
    FILE <span style="color:#f92672">*</span>example <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;example.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
    FILE <span style="color:#f92672">*</span>curwd <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;./&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
    <span style="color:#66d9ef">int</span> result1 <span style="color:#f92672">=</span> fchmod(fileno(example), S_IROTH <span style="color:#f92672">|</span> S_IRUSR);
    <span style="color:#66d9ef">int</span> result2 <span style="color:#f92672">=</span> chmod(<span style="color:#e6db74">&#34;example.txt&#34;</span>, S_IROTH <span style="color:#f92672">|</span> S_IRUSR);
    <span style="color:#66d9ef">int</span> result3 <span style="color:#f92672">=</span> fchmodat(fileno(curwd), <span style="color:#e6db74">&#34;example.txt&#34;</span>, S_IROTH <span style="color:#f92672">|</span> S_IRUSR, <span style="color:#ae81ff">0</span>);
    printf(<span style="color:#e6db74">&#34;%d, %d, %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result1, result2, result3);
    fclose(example); 
    fclose(curwd);
}</code></pre></div>
<p>We can simulate the error from the application by running this example program with a file that it is unable to work on.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aun@silent:~/src/preload-chmod$ cc example.c -o example
aun@silent:~/src/preload-chmod$ touch example.txt
aun@silent:~/src/preload-chmod$ sudo chown root:root example.txt
aun@silent:~/src/preload-chmod$ strace -f -e chmod,fchmod,fchmodat ./example 
fchmod<span style="color:#f92672">(</span>3, 0404<span style="color:#f92672">)</span>                         <span style="color:#f92672">=</span> -1 EPERM <span style="color:#f92672">(</span>Operation not permitted<span style="color:#f92672">)</span>
chmod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;example.txt&#34;</span>, 0404<span style="color:#f92672">)</span>              <span style="color:#f92672">=</span> -1 EPERM <span style="color:#f92672">(</span>Operation not permitted<span style="color:#f92672">)</span>
fchmodat<span style="color:#f92672">(</span>4, <span style="color:#e6db74">&#34;example.txt&#34;</span>, 0404<span style="color:#f92672">)</span>        <span style="color:#f92672">=</span> -1 EPERM <span style="color:#f92672">(</span>Operation not permitted<span style="color:#f92672">)</span>
-1, -1, -1
+++ exited with <span style="color:#ae81ff">0</span> +++</code></pre></div>
<h2 id="research-the-example">Research the example</h2>
<p>I&rsquo;m planning to use LD_PRELOAD from <code>ld.so1</code> -S 8.  The man page states &ldquo;A list of additional, user-specified, ELF shared objects to be loaded before all others.  This feature can be used to selectively over‚Äêride functions in other shared objects.&rdquo; So, we need to check that this is indeed loaded from a shared library.  We can use some of the ld related tools to confirm this.  Results of example show below.  As you can see the functions are from the GLIBC dynamic library and can be over-ridden.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aun@silent:~/src/preload-chmod$ objdump -T example

example:     file format elf64-x86-64

DYNAMIC SYMBOL TABLE:
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.34  __libc_start_main
<span style="color:#ae81ff">0000000000000000</span>  w   D  *UND*	<span style="color:#ae81ff">0000000000000000</span>  Base        _ITM_deregisterTMCloneTable
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 fclose
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 printf
<span style="color:#ae81ff">0000000000000000</span>  w   D  *UND*	<span style="color:#ae81ff">0000000000000000</span>  Base        __gmon_start__
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 fileno
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.4   fchmodat
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 fchmod
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 chmod
<span style="color:#ae81ff">0000000000000000</span>      DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 fopen
<span style="color:#ae81ff">0000000000000000</span>  w   D  *UND*	<span style="color:#ae81ff">0000000000000000</span>  Base        _ITM_registerTMCloneTable
<span style="color:#ae81ff">0000000000000000</span>  w   DF *UND*	<span style="color:#ae81ff">0000000000000000</span>  GLIBC_2.2.5 __cxa_finalize</code></pre></div>
<h2 id="create-a-dl-so-for-use-by-ld_preload">Create a dl so for use by LD_PRELOAD</h2>
<p>In this case we want to wrap the calls to the various chmod functions and return success and take no action.  in the example for chmod the dlsym function is called to find the real implementation of chmod if that is needed.  Calling the real_chmod function loaded from dlsym will proxy the call the actual implementation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define _GNU_SOURCE
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt; </span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//gcc -shared -fPIC -ldl chmod_preload.c -o chmod_preload.so
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>fchmod_t)(<span style="color:#66d9ef">int</span> fd, mode_t mode);
fchmod_t real_fchmod;

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>fchmodat_t)(<span style="color:#66d9ef">int</span> dirfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, mode_t mode, <span style="color:#66d9ef">int</span> flags);
fchmodat_t real_fchmodat;

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>chmod_t)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, mode_t mode);
chmod_t real_chmod;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">chmod</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, mode_t mode) {
    printf(<span style="color:#e6db74">&#34;chmod wrapper</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>real_chmod) {
        real_chmod <span style="color:#f92672">=</span> dlsym(RTLD_NEXT, <span style="color:#e6db74">&#34;chmod&#34;</span>);
    }
    <span style="color:#75715e">// insert your logic here.  
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// in this case no action is taken and success is returned
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// return real_chmod(pathname, mode);
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

}
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fchmodat</span>(<span style="color:#66d9ef">int</span> dirfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, mode_t mode, <span style="color:#66d9ef">int</span> flags) {
    <span style="color:#75715e">// do nothing return success
</span><span style="color:#75715e"></span>    printf(<span style="color:#e6db74">&#34;fchmodat wrapper</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fchmod</span>(<span style="color:#66d9ef">int</span> fd, mode_t mode) {
<span style="color:#75715e">// do nothing return success
</span><span style="color:#75715e"></span>    printf(<span style="color:#e6db74">&#34;fchmod wrapper</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}</code></pre></div>
<p>Now to use the LD_PRELOAD so.  You can see an example of the example program failing with -1 EPERM errors with no changes.  Setting LD_PRELOAD so that ld.so can inject the library to intercept the call we see that the messages are printed as well as the success results.  A shared library similar to this example was used to workaround the original issue described until an application fix was avilable.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aun@silent:~/src/preload-chmod$ ./example 
-1, -1, -1
aun@silent:~/src/preload-chmod$ LD_PRELOAD<span style="color:#f92672">=</span>$PWD/chmod_preload.so ./example 
fchmod wrapper
chmod wrapper
fchmodat wrapper
0, 0, <span style="color:#ae81ff">0</span></code></pre></div>
<p>Enjoy!</p>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/family">family</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/fpw">fpw</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/functional">functional</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/linux">linux</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/observability">observability</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/programming">programming</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/security">security</a></span>
        
            <span class="tag"><a href="https://aunfl0w.github.io/tags/x">x</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="https://aunfl0w.github.io/2021/preload-fix/">Alter system calls with LD_PRELOAD</a></h1>
            <time class="has-text-grey-light is-size-7">16 October 2021</time>
        
            <h1><a href="https://aunfl0w.github.io/2021/mount-block-image/">Mount a block device image</a></h1>
            <time class="has-text-grey-light is-size-7">16 October 2021</time>
        
            <h1><a href="https://aunfl0w.github.io/2021/devops/">DevOps notes</a></h1>
            <time class="has-text-grey-light is-size-7">6 September 2021</time>
        
            <h1><a href="https://aunfl0w.github.io/2021/lkm/">Linux kernel module basics</a></h1>
            <time class="has-text-grey-light is-size-7">19 August 2021</time>
        
            <h1><a href="https://aunfl0w.github.io/2021/zpool-reimport/">zpool reimport</a></h1>
            <time class="has-text-grey-light is-size-7">30 July 2021</time>
        
    </div>
</div>
    <br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="https://aunfl0w.github.io/archives/2021">2021</a> (5)<br>
        
            <a href="https://aunfl0w.github.io/archives/2019">2019</a> (2)<br>
        
            <a href="https://aunfl0w.github.io/archives/2018">2018</a> (7)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://twitter.com/aunwick" class="mysocial"><i class="fab fa-twitter fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://github.com/aunfl0w" class="mysocial"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; Aun&#39;s Blog 2021 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
            - <a class="mysocial" href="https://aunfl0w.github.io/about">About</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
</body>
</html>
